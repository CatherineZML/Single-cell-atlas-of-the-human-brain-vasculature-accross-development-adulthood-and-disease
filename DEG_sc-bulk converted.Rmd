---
title: "DEG_sc-bulk converted"
author: "Moheb Ghobrial"
output: html_notebook
---


```{r}
sce <- SingleCellExperiment(assays = list(counts = counts), 
                            colData = metadata)


kids <- purrr::set_names(levels(sce$Plate))

kids


nk <- length(kids)
nk



sids <- purrr::set_names(levels(sce$MGMT))
# Total number of samples 
ns <- length(sids)
ns
n_cells <- as.numeric(table(sce$MGMT))


m <- match(sids, sce$MGMT)


ei <- data.frame(colData(sce)[m, ], 
                 n_cells, row.names = NULL) %>% 
  select(-"Plate")



groups <- colData(sce)[, c("Plate","MGMT")]


pb <- aggregate.Matrix(t(counts(sce)), 
                       groupings = groups, fun = "sum")






splitf <- as.factor(kids)
pbL <- split.data.frame(pb, 
                        factor(splitf)) %>%
  lapply(function(u) 
    set_colnames(t(u), 
                 stringr::str_extract(rownames(u), "(?<=_)[:alnum:]+")))


get_sample_ids <- function(x){
  pbL[[x]] %>%
    colnames()
}

de_samples <- map(1:length(kids), get_sample_ids) %>%
  unlist()


samples_list <- map(1:length(kids), get_sample_ids)

get_cluster_ids <- function(x){
  rep(names(pbL)[x], 
      each = length(samples_list[[x]]))
}

de_cluster_ids <- map(1:length(kids), get_cluster_ids) %>%
  unlist()


gg_df <- data.frame(cluster_id = de_cluster_ids,
                    sample_id = de_samples)


metadata= gg_df
metadata$group= paste(metadata$cluster_id, metadata$sample_id, sep = "_")
rownames(metadata) <- metadata$group



all(rownames(metadata) == colnames(pb.t))     

dds <- DESeqDataSetFromMatrix(pb.t, 
                              colData = metadata, 
                              design = ~ sample_id)

rld <- rlog(dds, blind=TRUE)



DESeq2::plotPCA(rld, intgroup = "sample_id")


rld_mat <- assay(rld)
rld_cor <- cor(rld_mat)
pheatmap(rld_cor, annotation = metadata[, c("sample_id"), drop=F])



dds <- DESeq(dds)
plotDispEsts(dds)



contrast <- c("sample_id", (metadata$sample_id)[2], (metadata$sample_id)[1])


res <- results(dds, 
               contrast = contrast,
               alpha = 0.05)


res.shr.cont <- lfcShrink(dds=dds, contrast=c("sample_id","Y","N"), res=res,  type = c("normal"))


res_tbl <- res %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>%
  as_tibble()

```

