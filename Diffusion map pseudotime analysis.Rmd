---
title: "Diffusion map pseudotime analysis"
author: "Moheb Ghobrial"
output: html_notebook
---


```{r}
#load libraries 
library(destiny)
library(Seurat)
library(ggplot2)
library(SingleCellExperiment)
library(future)


# Load the seurat object
seurat <- readRDS(file = "seurat.rds")


sce <- as.SingleCellExperiment(seurat)


# Make a diffusion map.
dm <- DiffusionMap(sce, verbose = TRUE, n_pcs = 50)

# Plot diffusion component 1 vs diffusion component 2 (DC1 vs DC2).
tmp <- data.frame(DC1 = eigenvectors(dm)[, 1],DC2 = eigenvectors(dm)[, 2],Timepoint = sce$RPCA_clusters)


ggplot(tmp, aes(x = DC1, y = DC2, colour = Timepoint)) +geom_point() + scale_color_manual(values = my_color)+ xlab("Diffusion component 1") + ylab("Diffusion component 2") + theme_classic()



# plot  diffusion component (DC1) as a measure of pseudotime.
sce$pseudotime_diffusionmap <- rank(eigenvectors(dm)[,1])

ggplot(as.data.frame(colData(sce)), 
aes(x = pseudotime_diffusionmap, y = RPCA_clusters, colour = RPCA_clusters)) +
geom_quasirandom(groupOnX = FALSE) +
scale_color_manual(values = my_color) + theme_classic() +
xlab("Diffusion component 1 (DC1)") + ylab("Timepoint") +
ggtitle("Cells ordered by DC1")


#Plot 3D diffusion map
colors_cluster <- c('EndoMT' = '#70fb52', 'Stem-to-EC' = '#4cd7a4', 'Mitochondrial' = '#f1b77c', 'Angiogenic capillary' = '#c300fe', 'Capillary' = '#fb00c9', 'Large artery' = '#a1000b', 'Artery' = '#d0000d','Vein' = '#29e2e6', 'Large vein' = '#0000b3',  'Venule' = '#6dc4fd', 'Arteriole' = '#d13b18', 'Proliferating cell' = '#FBFF00', 'Proliferating Stem-to-EC' = '#89e56b', 'Proliferating EndoMT' = '#affd2d')[as.character(Idents(seurat))]

plot3d(eigenvectors(dm)[, 1:3], col =colors_cluster )
rgl.snapshot('3dplot.png', fmt = 'png')


```
