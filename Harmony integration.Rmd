---
title: "Harmony integration/batch correction"
author: "Moheb Ghobrial"
output: html_notebook
---



```{r}
#source: https://github.com/satijalab/seurat-wrappers/blob/master/docs/harmony.md
# Harmony integration of the overall merge of endothelial cells


library(Seurat)
library(harmony)
library(Seurat)


#Load the datasets to integrate
FETAL <- readRDS(file = "FETAL.rds")
TL <- readRDS(file = "TL.rds")
AVM <- readRDS(file = "AVM.rds")
LGG <- readRDS(file = "LGG.rds")
GBM <- readRDS(file = "GBM.rds")
MEN <- readRDS(file = "MEN.rds")
MET <- readRDS(file = "MET.rds")


#Merge seurat objects
MERGEEC <- merge(AVM, y = c(GBM,LGG, MEN, MET, TL, FETAL)
                 
                 
MERGEEC <- NormalizeData(MERGEEC) %>% FindVariableFeatures() %>% ScaleData() %>% RunPCA(verbose = TRUE)

#The patient level information is in the "Plate" metadata 
MERGEEC <- RunHarmony(MERGEEC, group.by.vars = "Plate")
MERGEEC <- RunUMAP(MERGEEC, reduction = "harmony", dims = 1:30)
MERGEEC <- FindNeighbors(MERGEEC, reduction = "harmony", dims = 1:30) %>% FindClusters()
MERGEEC <- FindClusters(MERGEEC, resolution =c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7,0.8, 0.9, 1,1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2))
         
                 
                 
```
