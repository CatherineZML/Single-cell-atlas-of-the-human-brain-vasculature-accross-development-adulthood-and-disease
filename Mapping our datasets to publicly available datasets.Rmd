---
title: "Mapping our datasets to publicly available datasets"
author: "Moheb Ghobrial"
output: html_notebook
---



```{r}
library(Seurat)

#load reference and query datasets

query <- readRDS(file = "query.rds")
ref <- readRDS(file = "ref.rds")


query <- FindVariableFeatures(query, selection.method = "vst", nfeatures = 3000, verbose = FALSE)
ref <- FindVariableFeatures(ref, selection.method = "vst", nfeatures = 3000, verbose = FALSE)

anchors_ref.query <- FindTransferAnchors(reference = ref, query =query, project.query = TRUE, dims = 1:30, normalization.method = "LogNormalize")


predictions <- TransferData(anchorset = anchors_ref.query, refdata = ref$Annotation, dims = 1:20)

query <- AddMetaData(query, metadata = predictions)


#plot prediction score umap
FeaturePlot(object = query, features = "prediction.score.max", reduction = "umap", pt.size = 1.5)



#Modify the cell identities in the seurat object based on the max prediction score. Only consider scores above 0.5. 

cells_aboveThreshold = query@meta.data$prediction.score.max > 0.5
new_Idents = query@meta.data$predicted.id
new_Idents[!cells_aboveThreshold] = "Unassigned"
Idents(query) = new_Idents
query <- AddMetaData(query, metadata = as.factor(new_Idents), col.name = "ref_clusters")


#plot predicted ID on umap
DimPlot(query, reduction = "umap", group.by = "ref_clusters", label = TRUE, repel = TRUE, label.size = 4.5, pt.size = 1)

#plot sankey plot to visulaize mapping results
library(tidyverse)
library(viridis)
library(patchwork)
library(hrbrthemes)
library(circlize)
library(networkD3)


# extract metadata:
metadata <- as.data.frame(as.matrix(query@meta.data))
nodes <- data.frame(name=c(as.character(metadata$Annotation), as.character(metadata$ref_clusters)) %>% unique())


#plot sankey
sankeyNetwork(Links = metadata, Nodes = nodes, Source = "IDsource", Target = "IDtarget",Value = "prediction.score.max", NodeID = "name",sinksRight= FALSE, colourScale=ColourScal, nodeWidth=100, fontSize=15, nodePadding=10, LinkGroup = "ref_clusters", height = 500, width = 1000,iterations = 0, fontFamily = "Arial")

```

