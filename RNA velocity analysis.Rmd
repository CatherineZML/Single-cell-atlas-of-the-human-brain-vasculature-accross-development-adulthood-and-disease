---
title: "RNA velocity analysis"
author: "Moheb Ghobrial"
output: html_notebook
---

```
#in ubuntu
#To run velocyto on ubuntu:
#imp: the cell ranger output has to be in a folder called outs. 

velocyto run10x -m /hg38_rmsk.gtf /outs/ /genes.gtf 

python
import anndata
import scvelo as scv
import pandas as pd
import numpy as np
import matplotlib as plt
import dataframe_image as dfi
import cellrank as cr

#read loom file in
sample_one = anndata.read_loom("sample_one.loom")

sample_obs = pd.read_csv("cellID_obs.csv")
umap = pd.read_csv("cell_embeddings.csv")
cell_clusters = pd.read_csv("clusters.csv")


# To remove cells filtered out from the loom file (note that "x" is the column name of the "sample_obs" and "cellID_obs.csv" files.
sample_one = sample_one[np.isin(sample_one.obs.index,sample_obs["x"])]


#cast index as a data frame and change the column name
sample_one_index = pd.DataFrame(sample_one.obs.index)
sample_one_index = sample_one_index.rename(columns = {0:'CellID'})

#change the first column of our UMAP data frame to the same name:
umap = umap.rename(columns = {'Unnamed: 0':'CellID'})

umap_ordered = sample_one_index.merge(umap, on = "CellID")



# remove the first column of the data #frame and add the UMAP coordinates to our anndata object.
umap_ordered = umap_ordered.iloc[:,1:]
sample_one.obsm['X_umap'] = umap_ordered.values

#to add the cluster annotations 
cell_clusters = cell_clusters.rename(columns = {'Unnamed: 0':'CellID'})
cell_clusters_ordered = sample_one_index.merge(cell_clusters, on = "CellID")
cell_clusters_ordered = cell_clusters_ordered.iloc[:,1:]
sample_one.obs['clusters'] = cell_clusters_ordered.values


#Running RNA Velocity
scv.pp.filter_and_normalize(sample_one)
scv.pp.moments(sample_one)
scv.tl.velocity(sample_one, mode = "stochastic")
scv.tl.velocity_graph(sample_one)

scv.pl.velocity_embedding_stream(sample_one, basis='umap', palette={'EndoMT': '#70fb52', 'Stem-to-EC': '#4cd7a4', 'Mitochondrial': '#f1b77c', 'Angiogenic capillary': '#c300fe', 'Capillary': '#fb00c9', 'Large artery': '#a1000b', 'Artery': '#d0000d','Vein': '#29e2e6', 'Large vein': '#0000b3',  'Venule': '#6dc4fd', 'Arteriole': '#d13b18', 'Proliferating cell': '#FBFF00', 'Proliferating Stem-to-EC': '#89e56b', 'Proliferating EndoMT': '#affd2d'}, save= 'OM_sorted_1.pdf', dpi=300,legend_align_text='xy',legend_fontsize=6, legend_fontweight= 'normal')


#TO plot latent time
scv.tl.recover_dynamics(sample_one)
scv.tl.latent_time(sample_one)
scv.pl.scatter(sample_one, color="latent_time", color_map="gnuplot", save= 'TL_sorted_latent time.pdf')


top_genes = sample_one.var["fit_likelihood"].sort_values(ascending=False).index[:300]
top_genes_df = pd.DataFrame(top_genes)
top_genes_df.to_excel('top_genes.xls', index=False)
scv.pl.heatmap(sample_one, var_names=top_genes, sortby="latent_time", col_color="clusters", n_convolve=100, save= 'genes.pdf')

# VELOCITY LENGTH AND CONFIDENCE
scv.tl.velocity_confidence(sample_one)
keys = 'velocity_length', 'velocity_confidence'
scv.pl.scatter(sample_one, c=keys, cmap='coolwarm', perc=[5, 95], save= 'Velocity length and confidence.pdf')

# VELOCITY pseudotime
scv.pl.velocity_graph(sample_one, threshold=.05, color='clusters', save= 'Velocitycell-cellconnections.pdf')


# PAGA velocity graph
sample_one.uns['neighbors']['distances'] = sample_one.obsp['distances']
sample_one.uns['neighbors']['connectivities'] = sample_one.obsp['connectivities']
scv.tl.paga(sample_one, groups='clusters')
df = scv.get_df(sample_one, 'paga/transitions_confidence', precision=2).T
df.style.background_gradient(cmap='Blues').format('{:.2g}') .to_excel('PAGA.xlsx', engine='openpyxl')

#df.style.background_gradient(cmap='Blues').format('{:.2g}')
scv.pl.paga(sample_one, basis='umap', size=50, alpha=.1,
            min_edge_width=2, node_size_scale=1.5, save= 'Velocitycell-PAGA.pdf')


```

