---
title: "Figure 2 - RPCA integration of endothelail cells"
author: "Moheb Ghobrial"
output: html_notebook
---

```{r}
#Seurat developers page: https://satijalab.org/seurat/articles/integration_rpca.html

library(Seurat)

#Load the datasets to integrate
TL <- readRDS(file = "TL.rds")
HEM <- readRDS(file = "Hemangioblastoma.rds")
CAV <- readRDS(file = "CAV.rds")
LGG <- readRDS(file = "LGG.rds")
GBM <- readRDS(file = "GBM.rds")
MEN <- readRDS(file = "MEN.rds")
MET <- readRDS(file = "MET.rds")
AVM <- readRDS(file = "AVM.rds")
CAVadjTL <- readRDS(file = "CAVadjTL.rds")
FETAL <- readRDS(file = "FETAL.rds")

#Merge seurat objects
MERGEEC <- merge(AVM, y = c(CAV, GBM, HEM, LGG, MEN, MET, TL, CAVadjTL, FETAL)
                 
#split the dataset into a list of patient level seurat objects. The patient level information is in the "Plate" metadata                   
list <- SplitObject(MERGEEC, split.by = "Plate")

# normalize and identify variable features for each dataset independently
list <- lapply(X = list, FUN = function(x) {
    x <- NormalizeData(x, verbose = FALSE)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 3000,verbose = FALSE)
})



# select features that are repeatedly variable across datasets for integration run PCA on each
# dataset using these features
features <- SelectIntegrationFeatures(object.list = list, nfeatures = 3000)

list <- lapply(X = list, FUN = function(x) {
    x <- ScaleData(x, features = features, verbose = FALSE)
    x <- RunPCA(x, features = features, verbose = FALSE)
})

anchors <- FindIntegrationAnchors(object.list = list, anchor.features = features, reduction = "rpca")


#Perform integration
# original unmodified data still resides in the 'RNA' assay
INTEGRATED <- IntegrateData(anchorset = anchors, dims = 1:30)

INTEGRATED <- ScaleData(INTEGRATED, verbose = FALSE)
INTEGRATED <- RunPCA(INTEGRATED, verbose = FALSE)
INTEGRATED <- FindNeighbors(INTEGRATED, dims = 1:30)

INTEGRATED <- FindClusters(INTEGRATED, resolution = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7,0.8, 0.9, 1,1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2))

INTEGRATED <- RunUMAP(INTEGRATED, dims = 1:30)
INTEGRATED <- RunTSNE(INTEGRATED, dims = 1:30)





```

