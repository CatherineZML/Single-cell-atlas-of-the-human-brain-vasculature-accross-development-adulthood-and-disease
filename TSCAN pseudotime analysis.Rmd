---
title: "TSCAN pseudotime analysis"
author: "Moheb Ghobrial"
output: html_notebook
---


```{r}
#Source: http://bioconductor.org/books/3.14/OSCA.advanced/trajectory-analysis.html

#load libraries 
library(TSCAN)
library(SingleCellExperiment)
library(Seurat)
library(SeuratData)
library(SeuratWrappers)
library(ggplot2)
library(patchwork)
library(magrittr)
library(ggbeeswarm)
library(viridis)
library(ggbeeswarm)


# Load the seurat object
seurat <- readRDS(file = "seurat.rds")


sce <- as.SingleCellExperiment(seurat)

by.cluster <- aggregateAcrossCells(sce, ids=sce$RPCA_clusters)
centroids <- reducedDim(by.cluster, "UMAP")

# Set clusters=NULL as we have already aggregated above.
library(TSCAN)
mst <- TSCAN::createClusterMST(centroids, clusters=NULL)
mst


line.data <- reportEdges(by.cluster, mst=mst, clusters=NULL, use.dimred="UMAP")
plotUMAP(sce, colour_by="RPCA_clusters") + geom_line(data=line.data, mapping=aes(x=UMAP_1, y= UMAP_2, group=edge)) #We remove lines that go out of the main population

colLabels(sce) = sce$RPCA_clusters
map.tscan <- mapCellsToEdges(sce, mst=mst, use.dimred="UMAP")
tscan.pseudo <- orderCells(map.tscan, mst, start="Large artery")
head(tscan.pseudo)

# Taking the rowMeans just gives us a single pseudo-time for all cells. Cells
# in segments that are shared across paths have the same pseudo-time value for
# those paths anyway, so the rowMeans doesn't change anything.
common.pseudo <- rowMeans(tscan.pseudo, na.rm=TRUE)
sce$TSCANpseudotime = as.numeric(I(common.pseudo))


plotUMAP(sce, colour_by=I(common.pseudo), text_by="RPCA_clusters", text_colour="red") + geom_line(data=line.data, mapping=aes(x=UMAP_1, y= UMAP_2, group=edge)) + scale_color_viridis(discrete = FALSE, option = "E")

#plot a ggplot to ordercells 
ggplot(as.data.frame(colData(sce)), 
       aes(x = TSCANpseudotime, 
           y = factor(RPCA_clusters, level = level_order), colour = RPCA_clusters)) +
    geom_quasirandom(groupOnX = FALSE) +
    scale_color_manual(values = my_color) + theme_classic() +
    xlab("TSCANpseudotime") + ylab("Timepoint") +
    ggtitle("Cells ordered by TSCAN pseudotime")
dev.off()


```

