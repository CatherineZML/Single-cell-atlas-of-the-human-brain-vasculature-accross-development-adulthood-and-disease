---
title: "scANVI integration/batch correction"
author: "Moheb Ghobrial"
output: html_notebook
---

```
#in ubuntu
#To run velocyto on ubuntu:

import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
import pandas as pd

import scanpy as sc
import scvi
import scib


adata = sc.read("MERGEEC.h5ad")

sc.pp.highly_variable_genes(
    adata,
    n_top_genes=3000,
    batch_key="Plate",
    subset=False
)

scvi.model.SCVI.setup_anndata(adata, batch_key="Plate")
vae = scvi.model.SCVI(adata, n_layers=2, n_latent=30, gene_likelihood="nb")
vae.train()


adata.obsm["X_scVI"] = vae.get_latent_representation()



sc.pp.neighbors(adata, use_rep="X_scVI")

sc.tl.leiden(adata)

sc.tl.umap(adata, min_dist=0.2)

from scvi.model.utils import mde
import pymde
adata.obsm["X_mde"] = mde(adata.obsm["X_scVI"])


sc.pl.embedding(adata, basis="X_mde", color=["RPCA_clusters"], ncols=1, frameon=False)



lvae = scvi.model.SCANVI.from_scvi_model(
    vae,
    adata=adata,
    labels_key="RPCA_clusters",
    unlabeled_category="Unknown",
)


lvae.train(max_epochs=20, n_samples_per_label=100)


adata.obsm["X_scANVI"] = lvae.get_latent_representation(adata)
adata.obsm["X_mde_scanvi"] = mde(adata.obsm["X_scANVI"])


sc.pl.embedding(adata, basis="X_mde_scanvi", color=["RPCA_clusters"], ncols=1, frameon=False)



```

